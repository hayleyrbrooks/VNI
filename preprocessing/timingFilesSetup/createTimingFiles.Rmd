---
title: "createEventFiles"
author: "Hayley Brooks"
date: "5/27/2021"
output: html_document
---
##### Output:
  - An onset/timing file for each event on each run (3) for every participant (51)
  - events we are modeling for now: choice option display, decision, outcome, modulated by monetary amounts

##### Timing information
-Choice options were displayed for 2 seconds (forced viewing) then participants had 2 seconds to respond. Once they responded, the ISI (varied 1.75s-5.75s) began and anytime remaining in the 2 second response window was added to the ITI at the end of the trial. After the ISI, the outcome was shown for 1 second followed by the ITI (varied .75 - 4.75 plus the leftover response time (2-RT) ). ITI, ISI and RT are included in the raw dataset loaded below.

- There was a 15 second fixation at the start of each block (to allow the scanner to settle). The first trial started immediately after the fixation ended.


#### Set up
```{r}
rm(list=ls());  # clear environment


library("config");
config <- config::get();

# load timing files:
timingFilePath = file.path(config$path$data$timing_files); # location of event files for each participant and each run
timingFiles = list.files(timingFilePath, pattern= "*_event.csv", full.names = T); # store names of files that we will need

# load raw dataset for choiceset
RDMgroupCSVpath = file.path(config$path$data$raw_group,config$csvs$RDM_group_raw_csv);
RDMraw = read.csv(RDMgroupCSVpath); 

# Remove participant 13 (did not start risky decision-making task)
RDMraw = RDMraw[RDMraw$subjectIndex!=13,]
```

#### Subject Information
```{r}
subNum = unique(RDMraw$subjectIndex);
nSubRaw = length(subNum); # should be 51

```

#### Create tsv files
For a given trial, there are 5 events: choice display, choice/RT, ISI, outcome, ITI and 73 trials in each run for a total of 365 events in a run (1095 total events across all three runs because 5 x 219 = 1095);

We had a 15 second delay which = 32.6087 TRs, so we will delete 32 volumes in FSL and will need to adjust the timing files by .6087 seconds

Questions:
1a) use exact timing from matlab or do it based on how we set it 2s, 1s etc.
1b) round the timing? - look around for FSL guidelines
2) very slight delay between trial start and stimulus start, when rounding using digits =1, the two have an identical onset time, should we just combine this instead of separating?
3) at the end, offset everything by .6087 or is there a better way to do this?
4) combine the duration for stimulus start and decision window? need to model them separately? i think not? if not, go back and fix the event files
5) modeling decision (action) as decision window + RT? it would be when this happened in the time series
- make sure that we know what FSL does with those timing files when we tell it to remove the volumes in the feat first level analysis
6) will need to add event and onset files to RDAC - easier to mover over to RDAC now?

Onset files:
1) choice display modulated by mean expected value
2) 

```{r}

# start with a single participant and run and create onset files for stimulus display
tmpdf = read.csv(timingFiles[1])

# stimulus timing files 
 # parametric modulation = mean EV?
stimStartInd = which(tmpdf$eventType=="stimulusStart");

onset = round(tmpdf$onset[stimStartInd],digits=2); # onset
duration = round(tmpdf$duration[stimStartInd],digits=2); # duration
modulation = RDMraw$meanEV[RDMraw$subjectIndex==1 & RDMraw$block==1]; # mean EV

newfile = cbind(onset,duration, modulation)



# onset file names: stored in each participants' folder
# following this naming format: "rdm_choiceOptions_run#.txt"
write.table(newfile, file="/Users/shlab/Desktop/testOnsetfile.txt", row.names = F, col.names = F, sep="\t")



```



