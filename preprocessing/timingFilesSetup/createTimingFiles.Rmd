---
title: "createEventFiles"
author: "Hayley Brooks"
date: "5/27/2021"
output: html_document
---
##### Output:
  - An onset/timing file for each event on each run (3) for every participant (51)
  - events we are modeling for now: choice option display, decision, outcome, modulated by monetary amounts

##### Timing information
-Choice options were displayed for 2 seconds (forced viewing) then participants had 2 seconds to respond. Once they responded, the ISI (varied 1.75s-5.75s) began and anytime remaining in the 2 second response window was added to the ITI at the end of the trial. After the ISI, the outcome was shown for 1 second followed by the ITI (varied .75 - 4.75 plus the leftover response time (2-RT) ). ITI, ISI and RT are included in the raw dataset loaded below.

- There was a 15 second fixation at the start of each block (to allow the scanner to settle). The first trial started immediately after the fixation ended.


#### Set up
```{r}
rm(list=ls());  # clear environment


library("config");
config <- config::get();

# load timing files:
eventFilePath = file.path(config$path$data$event_files); # location of event files for each participant and each run
eventFiles = list.files(eventFilePath, pattern= "*_event.csv", full.names = T); # store names of files that we will need

# load raw dataset for choiceset
RDMgroupCSVpath = file.path(config$path$data$raw_group,config$csvs$RDM_group_raw_csv);
RDMraw = read.csv(RDMgroupCSVpath); 

# Remove participant 13 (did not start risky decision-making task)
RDMraw = RDMraw[RDMraw$subjectIndex!=13,]
```

#### Subject Information
```{r}
subNum = unique(RDMraw$subjectIndex);
nSubRaw = length(subNum); # should be 51

# Create a vector that has the sub IDs formatted as in BIDS (e.g. 001, 002)
subID_bids = vector(); # create empty vector

for (s in 1: nSubRaw){
  if(s<10){
   subID_bids[s]=paste("00",subNum[s],sep="")
  }
  else {
   subID_bids[s]=paste("0", subNum[s],sep="")
  }
};



```

#### Create txt files
For a given trial, there are 5 events: choice display, choice/RT, ISI, outcome, ITI and 73 trials in each run for a total of 365 events in a run (1095 total events across all three runs because 5 x 219 = 1095);

We had a 15 second delay which = 32.6087 TRs, so we will delete 32 volumes in FSL and will need to adjust the timing files by .6087 seconds. From FSL: "remember when setting up the design matrix that the timings in the design matrix start at t=0 seconds, and this corresponds to the start of the first image taken after the deleted scans. In other words, the design matrix starts after the deleted scans have been deleted.""

To create the onset files for FSL, we use timing information from the sub_0##_run#_event.csv files which were created using the timing output from the study sessions. We will start each trial with stimulus start (not trial start) because there is a very slight delay between trial start and stimulus start (trial starts, computer randomly decides location of gamble/safe location on screen, then shows the stimuli)

We will be combining duration for stimulus and decision window because these are identical with the exception that participants were allowed to respond once the decision window started.

For modeling decision(action), it would be when RT happened in the time series (not RTs themselves)

When done, add these timing files to RDAC


Onset files:

Choice:
- choiceDisp_meanEV_run#.txt: choice display modulated by mean expected value
- choiceDisp_gainAmt_run#.txt: choice display modulated by gain amount (mean center?)
- choiceDisp_safeAmt_run#.txt: choice display modulated by safe amount (mean center?)

Outcome:
- outcomeDisp_otcAmt_run#.txt: all outcomes, outcome amount
- outcomeDisp_otcWinAmt_run#.txt: win, received - not received 
- outcomeDisp_otcLossAmt_run#.txt: loss, received - not received
- outcomeDisp_otcSafeAmt_run#.txt: safe, amount received 

Decision: (when they made a choice)
- decision_run#.txt: choice (generally)
- decisionGamble_run#.txt: chose gamble
- decisionSafe_run#.txt: choice safe


```{r}

# start with a single participant and run and create onset files for stimulus display
tmpdf = read.csv(eventFiles[1])

# stimulus timing files 
 # parametric modulation = mean EV?
stimStartInd = which(tmpdf$eventType=="stimulusStart");

onset = round(tmpdf$onset[stimStartInd],digits=2); # onset
duration = round(tmpdf$duration[stimStartInd],digits=2); # duration
modulation = RDMraw$meanEV[RDMraw$subjectIndex==1 & RDMraw$block==1]; # mean EV

newfile = cbind(onset,duration, modulation)



# onset file names: stored in each participants' folder
# following this naming format: "rdm_choiceOptions_run#.txt"
write.table(newfile, file="/Users/shlab/Desktop/testOnsetfile.txt", row.names = F, col.names = F, sep="\t")



```

```{r} 
# LEFT OFF HERE - MAKE THIS DYNAMIC SO THAT WE CAN CREATE MULTIPLE TIMING FILES FOR ALL PARTICIPANTS
onsetFileNames = c("choiceDisp_meanEV_run1","choiceDisp_meanEV_run2", "choiceDisp_meanEV_run3",
                   "choiceDisp_gainAmt_run1","choiceDisp_gainAmt_run2","choiceDisp_gainAmt_run3",
                   "choiceDisp_safeAmt_run1","choiceDisp_safeAmt_run2","choiceDisp_safeAmt_run3")

# each participant has three event files, one for each run
# each event file has 438 rows (73 trials x 6 events)
nTblock = 73;
nEvents = 6;

for (s in 1:nSubRaw) {

  ind = grep(sprintf("sub-%s_run",subID_bids[s]), eventFiles); # get indices of event files for participant 
  
  eventrun1 = read.csv(eventFiles[ind[1]]); # load run 1
  eventrun2 = read.csv(eventFiles[ind[2]]); # load run 2
  eventrun3 = read.csv(eventFiles[ind[3]]); # load run 3
  
  RDMsub = RDMraw[RDMraw$subjectIndex==subNum[s],]

  # choice display (onset is stimStart onset, duration is stimStart duration + decisionWindow duration)
 
  stimStartInd = which(eventrun1$eventType=="stimulusStart");
  decWindowInd = which(eventrun1$eventType=="decisionWindow");
  
  onset = eventrun1$onset[stimStartInd]; # onset
  duration = eventrun1$duration[stimStartInd] + eventrun1$duration[decWindowInd]; # duration
  modulation = RDMraw$meanEV[RDMraw$subjectIndex==1 & RDMraw$block==1]; # mean EV

  newfile = cbind(onset,duration, modulation)

  
  newfilename = sprintf("%s/sub-%s/%s.txt", config$path$data$onset_files,subID_bids[s],onsetFileNames[1])
  write.table(newfile, file=newfilename, row.names = F, col.names = F, sep="\t")

  
}

```
  

