---
title: "VNI Analysis of RDM behavior"
author: "Hayley Brooks"
output:
  #pdf_notebook: default
  html_notebook: default
---

##### Set up
```{r Set-up, include=FALSE}
rm(list=ls());  # clear environment


library(config);
config <- config::get();

vni_csv = file.path(config$path$data$clean,config$csvs$RDM_group_clean_csv);
mriBehClean = read.csv(vni_csv);


library(lme4);
library(lmerTest);
```

***
##### Subject information
```{r subject-information}
subIDs = unique(mriBehClean$subjectIndex);
nSub = length(subIDs);
nSub
#sprintf("N = %s", nSub)
```

***
### Big Question
#### Does risk-taking change as a function of temporal context at three levels?
1) Immediate (past outcome) 
2) Neighborhood (shifts) 
3) Global (earnings relative to expected)


***

### Trial-level model
##### Summary: Participants more likely to choose an option as its amount increases (no effect of ground expected value)
```{r trial-level-glmer}
model1_trialLevel = glmer(choice~ 0 + gainSC + altSC + grndEVscaled + (0+ gainSC + altSC|subjectIndex), data = mriBehClean, family = "binomial"); # model identical to VIC

summary(model1_trialLevel);

```

***
#####  Pull out "predicted" values from trial-level model and save as variable "pred" in mriBehClean dataframe
**Using "offset", they'll be applied inside the softmax with a weight of 1 every time, in effect accounting for our best current-trial predictions by directly entering those predictions on a trial-by-trial level. This lets us retain the binomial analysis structure vs using residuals ("resids"), which is much more accurate.**

```{r save-predicted-values}
mriBehClean$pred= predict(model1_trialLevel,type="link"); 
par(mfrow=c(1,1))
#plot(mriBehClean$pred, ylab="predicted values");

```

***
#### 1) Immediate timescale: past outcome  
##### Past outcome amount and type: past outcome and type alone in models both not significant. In a model with past outcome type, type is significant (beta = .12(.06), p=.03) and interacts with outcome amount (beta = -.54(.2), p=.005). The model with the interaction performs better by AIC comparison.
```{r}
model2_potc_amt = glmer(choice ~ 0 + poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_amt);  # ns; AIC = 7592.9 

model2_potc_type = glmer(choice ~ 0 + poc1type + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_type); # ns; AIC =7592.1 

model2_potc_amt_type_intxn = glmer(choice ~ 0 + poc1type*poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_amt_type_intxn); # negative interaction between outcome type and amount; AIC = 7588.0

```

**Plot the interaction between past outcome amount and type:**  
**Outcome type is coded: 0 = safe; 1 = risky gain; -1 = risky loss (always $0)**
```{r plot-intxn-poc-type, include=FALSE}

m2coef = fixef(model2_potc_amt_type_intxn); # store all beta estimates

typeCoef = m2coef[1]; # past outcome type coefficient
amtCoef = m2coef[2]; # past outcome amount coefficient
intxnCoef = m2coef[3]; # past outcome type and amount interaction coefficient

## SAFE OUTCOMES
# Largest outcome when a participant rejected gamble = 30.49, scaled = .499918
# smallest outcome when a participant rejected gamble  = .78, scaled = .01278898
PgamPOCsafeSmall = 1/(1+exp(-1*( (typeCoef*0) + (amtCoef*.499918) + (intxnCoef*0*.499918) ))); 
# probability of gambling following a small, safe past outcome  = 0.5275424, 2.7% increase

PgamPOCsafeLarge = 1/(1+exp(-1*( (typeCoef*0) + (amtCoef*.01278898) + (intxnCoef*0*.01278898) ))); 
# probability of gambling following a large, safe past outcome  = 0.5007053 

## GAINS
# largest outcome when a participant accepted gamble and won = $60.99, scaled = 1
# smallest outcome when a participant accepted gamble and won = $5.31, scaled = 0.08706345
  # technically, the minimum it could be 0 if participants missed an attn check
# medium outcome = $30.5, scaled = .5
# outcome when a participant accepted gamble and lost = $0

PgamPOCwinLarge = 1/(1+exp(-1*( (typeCoef*1) + (amtCoef*1) + (intxnCoef*1*1) ))); 
# probability of gambling following a large, risky win = 0.4511035, 5% decrease 
PgamPOCwinSmall = 1/(1+exp(-1*( (typeCoef*1) + (amtCoef*0.08706345) + (intxnCoef*1*0.08706345) ))); 
# probability of gambling following a small, risky win = 0.5237715, a 2% increase
PgamPOCwinMedium = 1/(1+exp(-1*( (typeCoef*1) + (amtCoef*.5) + (intxnCoef*1*.5) ))); 
# probability of gambling following a medium, risky win = 0.4908425, a slight (<1%) decrease


## LOSSES (always zero)
PgamPOClossZero = 1/(1+exp(-1*( (typeCoef*-1) + (amtCoef*0) + (intxnCoef*-1*0) ))); 
# probability of gambling following a loss = 0.4693025, a 4.5% decrease


plot(c(PgamPOCwinSmall, PgamPOCwinMedium, PgamPOCwinLarge), type="l", col="green", lwd=3, ylim=c(0,1), main="Risk-taking as a function of past outcome type and amount", ylab="p(gamble)", xlab="past outcome", axes=F)
legend("topleft", legend=c("gain", "loss", "safe"), text.col = c("green", "red", "blue"), bty="n")
axis(2)
axis(1, labels=c("small", "medium", "large"), at=c(1,2,3))
lines(c(PgamPOCsafeSmall,PgamPOCsafeLarge), col="blue", lwd=3)
points(c(PgamPOClossZero), pch=16, col="red", lwd= 3)



```

It looks like there is a very slight difference between loss and gain/safe outcome. Do people treat losses like a missed gain? No, doesn't look like that is happening here.
```{r missed-gain, include=FALSE}
# Missed gain variable - positive value for losses (its the previous risky gain amount). Note that this is the missed gain on the previous trial.
model2_potc_missedGain_type_intxn = glmer(choice ~ 0 + pocMissedGain*poc1type+ (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_missedGain_type_intxn); #AIC = 7594.1, nothing is significant

# Another way to look at this would be a regressor that is received - not received (so it is one continuous regressor that includes losses(missed gains), wins, and safes on the previous trial). Don't need to include type here.
model2_potc_receivedDiff_type_intxn = glmer(choice ~ 0 + pocRcvdMinusNotSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_receivedDiff_type_intxn); #AIC = 7589.2. ns

```


***
#### 2) Neighborhood timescale: Shifts 
##### Summary: Risk-taking increases following a positive shift only and the effect is short-lasting (similar to VIC). Shift does not interact with run size or past outcome.
```{r shift-effects}
model3_signed_shifts = glmer(choice~0 + shiftDiffsc + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_signed_shifts); # signed shift difference, significant

model3_abs_shift = glmer(choice ~ 0 + shiftDiffscABs + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_abs_shift); # absolute shift difference, ns

model3_pos_neg_shifts = glmer(choice ~ 0 + shiftDiffscPOS + shiftDiffscNEG + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_pos_neg_shifts); # both positive and negative shift difference, only positive significant
m3_coef_posShift = fixef(model3_pos_neg_shifts)[1];

## Plot the effect of positive shift
# scaled shift amounts = 0 to .33 (or 0 to 20 nonscaled)
PgamPosShiftZero = 1/(1+exp(-1*( (m3_coef_posShift*0) ))); # should be .5
PgamPosShiftLarge = 1/(1+exp(-1*( (m3_coef_posShift*.33) )));
# probability of gambling following large positive shift = 0.6518448, a %15.2 increase
PgamPosShiftMedium = 1/(1+exp(-1*( (m3_coef_posShift*.16) )));
# probability of gambling following medium positive shift = 0.5754388, a %7.5 increase


plot(c(PgamPosShiftZero, PgamPosShiftMedium,PgamPosShiftLarge), type="l", lwd=3, col="blue", axes=F, ylab="p(gamble)", xlab="positive shift", main="risk taking as a function of positive shift")
axis(1, labels=c("no shift", "medium", "large"), at=c(1,2,3))
axis(2)



```

#### How far back does shift effect go?
```{r shift-how-far-back}
# create new positive shift variable (n-1)
newMat = matrix(data=NA,nrow=nrow(mriBehClean), ncol=2);
newMat[,1] <- mriBehClean$shiftDiffscPOS; #take data from columns
newMat[2:nrow(newMat),1] <- newMat[1:(nrow(newMat)-1),1]; # removes first row, shifts everything up
newMat[1,1] <- NaN #put Nan in for first row (first trial for subject 1, bc there is no past trial)
newMat[,2]<-c(0,diff(mriBehClean$subjectIndex)); #put differences between subjectIndex into newvector, 1s show up when subject changes
newMat[newMat[,2]==1,]=NaN; #in newmtx, when diff = 1, replace with NaN, this replaces first trial with nan
mriBehClean$shiftDiffscPOS1 = newMat[,1];# add new vector to mriBehClean

# do the regressions
model3_pos_shift_howfarback = glmer(choice ~ 0 + shiftDiffscPOS + shiftDiffscPOS1 + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_pos_shift_howfarback); #short lasting, only trial directly after a shift

```


#### Does positive shift interact with previous run size or past outcome?
```{r}

# positive shift amount and run size before positive shift
model3_shift_pos_runSize = glmer(choice ~ 0 + shiftDiffscPOS*runSizePOS +(1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_shift_pos_runSize); # all betas ns


# both positive and negative shift and run size before positive and negative shift
model3_shift_pos_neg_runSize = glmer(choice ~ 0 + shiftDiffscPOS*runSizePOS + shiftDiffscNEG*runSizeNEG + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_shift_pos_neg_runSize); #all betas ns



# Does positive shift interact with past outcome?
model3_posShift_potc_intxn = glmer(choice ~ 0 + shiftDiffscPOS*poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_posShift_potc_intxn); #all betas ns


```

***
#### 3) Global timescale: Earnings
##### Summary: Cumulative earnings are more tied to trial than previous datasets, even VIC. Earnings and trial have opposite effects with risk-taking increasing with earnings and decreasing across the task. There is a trending interaction between trial and earnings (p=.06). AIC is better in model that includes both terms and an interaction between them.
```{r earnings-trial}

# First looking at earnings and trial in a model (no past outcome, shift variable)
model4_earnings_trial = glmer(choice~0 + earningsSC + trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earnings_trial); # both significant, betas similar size but opposite valence, AIC = 7649.2 


model4_earningsNorm_trial = glmer(choice~0 + earningsNormalized + trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earningsNorm_trial); # both significant, betas similar size but opposite valence, AIC = 7657.1

# model earning scaled fits better than earnings normalized - allowing individuals to vary does a little better than them all ending at the same place (i.e. at 1)



# pull and store coefficients
m4_coef_trial_Earn = fixef(model4_earnings_trial);
earnCoef = m4_coef_trial_Earn[1];
triCoef = m4_coef_trial_Earn[2];

# plot a couple of subs' earnings and pgamble over the task as a function of earnings and trial
sub1 = mriBehClean[mriBehClean$subjectIndex==7,];
PgamSub1EarnTrial =1/(1+exp(-1*( (triCoef*sub1$trialSC) + (earnCoef*sub1$earningsSC) )));

sub2 = mriBehClean[mriBehClean$subjectIndex==35,];
PgamSub2EarnTrial =1/(1+exp(-1*( (triCoef*sub2$trialSC) + (earnCoef*sub2$earningsSC) )))

sub3 = mriBehClean[mriBehClean$subjectIndex==52,];
PgamSub3EarnTrial =1/(1+exp(-1*( (triCoef*sub3$trialSC) + (earnCoef*sub3$earningsSC) )))

sub4 = mriBehClean[mriBehClean$subjectIndex==15,];
PgamSub4EarnTrial =1/(1+exp(-1*( (triCoef*sub4$trialSC) + (earnCoef*sub4$earningsSC) )))

sub5 = mriBehClean[mriBehClean$subjectIndex==28,];
PgamSub5EarnTrial =1/(1+exp(-1*( (triCoef*sub5$trialSC) + (earnCoef*sub5$earningsSC) )))

#pdf("/Users/hayley/Desktop/shenhavLabTalk/vniEarningsExpectations.pdf")
plot(PgamSub1EarnTrial, type="l", col="darkgreen", lwd=3, ylim=c(.4,.6), ylab="p(gamble)", xlab="trial", main="risk taking as a function\n of trial and earnings", axes = F)
abline(a=.5, b=0, lty="dashed", col="darkgrey", lwd=2)

axis(1, at=c(1,110,219), lwd=5)
axis(2, lwd=5)
lines(PgamSub2EarnTrial, col="darkred", lwd=3);
lines(PgamSub3EarnTrial, col="darkblue", lwd=3);
lines(PgamSub4EarnTrial, col="darkorange", lwd=3);
lines(PgamSub5EarnTrial, col="goldenrod", lwd=3);
legend("bottomright", legend=c("sub 7","sub 15", "sub 28" ,"sub 35", "sub 52"), lty = 1, lwd=3, bty="n", col=c("darkgreen", "darkorange", "goldenrod", "darkred","darkblue"), cex=.75)
#dev.off()

plot(sub1$earningsSC,type="l", col="darkgreen", lwd=3, xlab="trial", ylab="earnings (normalized)", main="earnings across the task", ylim=c(0,1))
lines(sub2$earningsSC, col="darkred", lwd=3)
lines(sub3$earningsSC, col="darkblue", lwd=3)
lines(sub4$earningsSC, col="darkorange", lwd=3)
lines(sub5$earningsSC, col="goldenrod", lwd=3)

legend("bottomright", legend=c("sub 7","sub 15", "sub 28" ,"sub 35", "sub 52"), lty = 1, lwd=3, bty="n", col=c("darkgreen", "darkorange", "goldenrod", "darkred","darkblue"), cex=.75)

# Plot #1 basically shows the difference between earnings and trial

```


```{r plot-intxn-earnings-trial}
# Model and plot with interaction term between earnings and trial
    # Interaction was trending here, so I am not sure how much to focus on this. The above model and plots seem more informative.
model4_earnings_trial_intxn = glmer(choice~0 + earningsSC*trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earnings_trial_intxn); # interaction significant, effects of trial and earnings similar as previous models except that earnings beta is slightly smaller now AIC = 7647.1


model4_earningsNorm_trial_intxn = glmer(choice~0 + earningsNormalized*trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earningsNorm_trial_intxn); # no interaction but earnings and trial significant as above AIC = 7655.5



```


Plot cumulative earnings for all participants across the task
```{r plot-earnings-subs}
plot(mriBehClean$earnings[mriBehClean$subjectIndex==1], type = "l",lwd = 2, ylim = c(0,max(mriBehClean$earnings)), xlim= c(0,219), main = "Earnings across task\n each line is a participant", ylab = "earnings", xlab="trial number", axes=FALSE)
axis(1, label = c(1, 219), at = c(1,219), tck = 0, lwd = 3)
axis(2, label = c(0, max(mriBehClean$earnings)), at = c(0,max(mriBehClean$earnings)), tck = 0, lwd =3)
for(s in 2:nSub){
  points(mriBehClean$earnings[mriBehClean$subjectIndex==s], type="l", lwd = 1, col = mriBehClean$subjectIndex/.2+s)
};
```



##### Do earnings interact with outcome? 
```{r earnings-intxn-poc}
# Earnings interact with past outcome in previous datasets, does that happen here?
#model4_earnings_potc_intxn = glmer(choice~0 + earningsSC*poc1scaled + trialSC*poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
#summary(model4_earnings_potc_intxn); # AIC = 7554.7 
# past outcome negative effect
# interaction between outcomes and earnings is trending 
# Main effects of earnings and trial go away (consistent with previous datasets, eg. VIC). 

#shift is not in this model, but when we do add shift, there is a similar pattern in behavior, interaction between outcome and trial is trending p=.08 and trial and earnings not significant.Strong effect of positive shift AIC =  7552.4 - including shift improves model fit.
model4_earnings_potc_intxn_shift = glmer(choice~0 + earningsSC*poc1scaled + trialSC*poc1scaled + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earnings_potc_intxn_shift);


# store model results
m4_earnPOCintxn_coefs = fixef(model4_earnings_potc_intxn_shift)
earnCoef_2 = m4_earnPOCintxn_coefs[1] 
pocCoef = m4_earnPOCintxn_coefs[2];
pocEarnCoef = m4_earnPOCintxn_coefs[4]
pocTrialCoef = m4_earnPOCintxn_coefs[5]

# PSH did a thing to figure out what the effect of past outcome is given the difference between expectations (trial) and how someone is doing (earnings). Since they are both scaled 0 to 1, you can do the following:
# past outcome beta + (earnings x otc beta * pick an earning value) + (trial x otc beta * pick a beta value)

# earlier in the task:
# pocCoef + pocEarnCoef*.2 + pocTrialCoef*.3 = -1.027033   # doing worse than expected 
# pocCoef + pocEarnCoef*.3 + pocTrialCoef*.3 =  -0.238776  # doing as expected 
# pocCoef + pocEarnCoef*.4 + pocTrialCoef*.3 =  0.5494805  # doing better than expected

# middle of the task
# pocCoef + pocEarnCoef*.5 + pocTrialCoef*.6 = -0.5019535  # doing worse than expected 
# pocCoef + pocEarnCoef*.6 + pocTrialCoef*.6 =  0.2863031  # doing as expected 
# pocCoef + pocEarnCoef*.7 + pocTrialCoef*.6 =  1.07456    # doing better than expected

# late in the task:
# pocCoef + pocEarnCoef*.7 + pocTrialCoef*.8 = -0.1519007  # doing worse than expected 
# pocCoef + pocEarnCoef*.8 + pocTrialCoef*.8 = 0.6363558   # doing as expected 
# pocCoef + pocEarnCoef*.9 + pocTrialCoef*.8 =  1.424612   # doing better than expected

# Overall, when participants did worse than expected, they took less risks and when earnings are more than expected, they took more risks and this pattern is stronger following a large outcome relative to a small outcome. It is possible that past outcome is the vehicle for the interaction between earnings and outcome, and trial and outcome. Likely a discussion for the supplement as a possible "why" for the interaction between two timescales.

# Plot interaction between outcome and earnings

poc= rep(c(0,.5,1), times =3)
earnings = rep(c(.0, .5, 1), each =3)


PgamPOCearningsIntxn =1/(1+exp(-1*( (earnCoef_2*earnings) + (pocCoef*poc) + (pocEarnCoef*poc*earnings) )));

plot(PgamPOCearningsIntxn[1:3], type="l", lwd = 3, col = "pink", ylab= "p(gamble)", xlab="past outcome", axes=F, ylim= c(min(PgamPOCearningsIntxn), max(PgamPOCearningsIntxn)), main="risk taking as a function of \n earnings and past outcome");
lines(PgamPOCearningsIntxn[4:6], lwd=3, col="pink2")
lines(PgamPOCearningsIntxn[7:9], lwd=3, col="pink4")
axis(2)
axis(1, at=c(1:3), labels = c("small", "medium", "large"))
legend("right", legend=c("zero", "medium", "large"), bty="n", lty=1, lwd=3, col=c("pink","pink2", "pink4"), title="earnings:")


```


### Each timescale in a single model:
#### Summary: Similar effects that we have noted prior: negative past outcome effect that interacts with cumulative earnings and positive shift effect. 
```{r all-timescales}
model5_potc_posshift_earn_trial = glmer(choice ~ 0 + poc1scaled*earningsSC + shiftDiffscPOS + trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred)

summary(model5_potc_posshift_earn_trial); # everything significant, AIC = 7546.3 
# FOR NOW, WILL USE THE BETA ESTIMATES FROM ABOVE MODEL TO CREATE TIMNING FILES FOR BOLD ANALYSIS
# EARNINGS BETA = 2.3959
# EXPECTATIONS BETA = -2.1927

model5_potc_posshift_earnExpIntxn_trial = glmer(choice ~ 0 + poc1scaled*earningsSC + shiftDiffscPOS + earningsSC*trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred)

summary(model5_potc_posshift_earnExpIntxn_trial); # everything significant but interaction between expectations and earnings, AIC = 7547.9


# What if we let expectations vary by individuals 
model5_potc_posshift_earn_expRFX_trial = glmer(choice ~ 0 + poc1scaled*earningsSC + shiftDiffscPOS + (1 + trialSC + earningsSC|subjectIndex), data=mriBehClean, family="binomial", offset=pred)
summary(model5_potc_posshift_earn_expRFX_trial)
# 7534.8
# earnings no longer significant but interaction between earnings and past outcome is, past outcome effect significant and negative and positive shift is significant.
#model doesn't converge and is singular but people do vary in expectations
# this model is technically better than the one above

```

##### Plot earnings x outcome effect using the model above (the interaction term is much smaller than in m4_earning_potc_intxn model), so we'd expect the switching of the past outcome effect to be less intense:
```{r plot-earnings-outcome-intxn}
# store model results
model5_coef = fixef(model5_potc_posshift_earn_trial)
m5earnCoef = model5_coef[2]; 
m5pocCoef = model5_coef[1];
M5intxnCoef = model5_coef[5];

# Plot interaction between outcome and earnings

poc= rep(c(0,.25,.5,.75, 1), times =5);
earnings = rep(c(0,.25,.5,.75, 1), each =5);


PgamPOCearningsIntxn =1/(1+exp(-1*( (m5earnCoef*earnings) + (m5pocCoef*poc) + (M5intxnCoef*poc*earnings) )));

plot(PgamPOCearningsIntxn[1:5], type="l", lwd = 3, col = "pink", ylab= "p(gamble)", xlab="past outcome ($)", axes=F, ylim= c(0,1), main="risk taking as a function of \n earnings and past outcome (big model 5)");
lines(PgamPOCearningsIntxn[6:10], lwd=3, col="lightpink")
lines(PgamPOCearningsIntxn[11:15], lwd=3, col="pink2")
lines(PgamPOCearningsIntxn[16:20], lwd=3, col="pink3")
lines(PgamPOCearningsIntxn[21:25], lwd=3, col="pink4")
axis(2)
axis(1, at=c(1:5), labels = round(poc[1:5]*max(mriBehClean$riskyGain), digits=2))
legend("bottomleft", legend=c("zero", "small", "medium", "medium-large", "large"), bty="n", lty=1, lwd=3, col=c("pink","lightpink", "pink2" ,"pink3", "pink4"), title="earnings:")
```


```{r level-tracking} 
# In the figure above showing risk taking as a function of earnings and trial because they have opposite effects. Could it be that these effects are capturing the overall difference between actual earnings and expected earnings (which could be captured by a linear regressor like trial)? This could imply that people are adjusting their risky choice behavior depending on how they are doing compared to how they EXPECT to be doing. If that is the case, then points above p(Gamble) = .5 implies that when people do better than expected, there is more risk-seeking and points below p(Gamble) = .5 implies that when people are doing worse than expected, there is less risk-seeking.

# Our task includes small --> large shifts up and down which could add to how people may expect to be doing (are they adjusting their expectations differently across the levels of context)? One way to account for this is by a 'level-tracking' variable (just adding up level on each trial, which will be a very similar variable to cumulative earnings). This variable is scaled between 0 and 1 for each participant (normalized within participant)


# Run some regressions adding level-tracking and compare to our model above with trial, earnings, poc*earnings, positive shift (AIC = 7553.0).


# trial, level tracking, earnings, poc, positive shift, earnings*poc. 
model4_expectedEarn = glmer(choice~0 + trialSC + earningsSC*poc1scaled + levelTrackingNorm + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
# AIC = 7554.5
#                         Estimate Std. Error z value Pr(>|z|)    
# trialSC                -2.6802     0.8902  -3.011  0.00260 ** 
# earningsSC              2.0048     0.8904   2.251  0.02436 *  
# poc1scaled             -0.7889     0.1689  -4.671 3.00e-06 ***
# levelTrackingNorm       0.8284     1.0434   0.794  0.42726    
# shiftDiffscPOS          2.4173     0.7483   3.230  0.00124 ** 
# earningsSC:poc1scaled   2.0059     0.3777   5.310 1.09e-07 ***

# larger AIC than model without level tracking, level tracking variable is not significant

# trial, level tracking, level tracking * poc, positive shift (no cumulative earnings).
model4_expectedEarn_noCumulativeEarn = glmer(choice~0 + trialSC + levelTrackingNorm*poc1scaled + levelTrackingNorm + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);  
# all significant, AIC =  7555.0 which is worse than model with earnings and level tracking (AIC = 7554.5) and model with earnings only (AIC = 7553.0)

# replacing cumulative earnings with level tracking variable  - results resemble the model when using cumulative earnings but model fails to converge. The beta estimates for trial and level tracking are similar but opposite direction and the interaction between poc and level tracking estimate/p value are similar to cumulatve earnings and poc scaled in previous model. Is level tracking and cumulative earnings too similar?

# take out trial 
model4_expectedEarn_noTrial = glmer(choice~0 + earningsSC*poc1scaled + levelTrackingNorm + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);

summary(model4_expectedEarn_noTrial); # AIC = 7555.2 - this has larger AIC than our original model 


# The best model includes trial and cumulative earnings (not level tracking). This seems like expectations are not changing level-wise. It looks like people are not significantly adjusting their expectations (in Khaw (2017) people are adjusting after hundreds of trials). If it is the case that people are not adjusting their expectations, are they not adjusting their reference point?

```


A few things seem to be happening: (model5_potc_posshift_earn_trial). 
# 1) There is a negative past outcome effect
# 2) There is a shift effect
# 3) There is a sign that there is something happening at the third level but the effect is happening across several regressors (earnings, trial, earnings x outcome, and possibly trial x outcome). It is not a nicely itemized effect like shift and past outcome effects and this effect could be happening as a result of the first level (past outcome). While it seems like one thing is happening, previous outcome effect changes based on how you're doing relative to expectations but it is so spread out across the variables that it makes the model with everything in it (the model including trial * poc) challenging. We could create a variable that captures the difference between earnings and expected earnings but the issue here is that we have to estimate the weighting - we try this at the end of this section:
```{r relative-earnings}

# Model results from model5_potc_posshift_earn_trial
#                               Estimate Std. Error z value Pr(>|z|)    
# poc1scaled             -0.7804     0.1684  -4.635 3.57e-06 ***
# earningsSC              2.3959     0.7464   3.210 0.001327 ** 
# shiftDiffscPOS          2.3774     0.7463   3.186 0.001444 ** 
# trialSC                -2.1927     0.6397  -3.428 0.000609 ***
# poc1scaled:earningsSC   1.9885     0.3768   5.277 1.31e-07 ***
# AIC = 7546.3 

# Add and interaction between trial and poc

model5_potc_posshift_earn_trial_intxns = glmer(choice~0 + earningsSC*poc1scaled + trialSC*poc1scaled + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model5_potc_posshift_earn_trial_intxns); # AIC =  7547.1  - slightly worse AIC than above above

#                               Estimate Std. Error z value Pr(>|z|)    
#                       Estimate Std. Error z value Pr(>|z|)    
# earningsSC              1.5493     1.0629   1.458  0.14495    
# poc1scaled             -0.7730     0.1685  -4.589 4.46e-06 ***
# trialSC                -1.4531     0.9200  -1.579  0.11424    
# shiftDiffscPOS          2.3304     0.7469   3.120  0.00181 ** 
# earningsSC:poc1scaled   5.2010     2.9242   1.779  0.07530 .  
# poc1scaled:trialSC     -2.8280     2.5552  -1.107  0.26839   

# no interaction between outcome and trial. Past outcome, shift, and interaction between past outcome and earnings trending. Now the main effect of earnings and trial not there.

# Can we create a variable that makes this model more interpretable??? What about a relative earnings variable that captures the difference between earnings and trial? The thing here is that we still have to add trial or earnings because the relative earnings variable gives earnings and trial the same weight and adding one of those variables to the model lets us figure out the weighting.
# Create a relative earnings variable (cumulative earnings - trial SC)
mriBehClean$relativeEarnings = mriBehClean$earningsSC - mriBehClean$trialSC;
# positive values = earnings more than expected
# negative values = earnings less than expected

m5_potc_shift_relativeEarn_trial = glmer(choice~ 0 + relativeEarnings*poc1scaled + trialSC*poc1scaled + shiftDiffscPOS+ (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);

# AIC = 7547.1 - same as model directly above (with trial*poc, earning*poc, shift) as expected
# relativeEarnings             1.54925    1.10266   1.405  0.16002    
# poc1scaled                  -0.77303    0.16850  -4.588 4.48e-06 ***
# trialSC                      0.09615    0.16953   0.567  0.57060    
# shiftDiffscPOS               2.33036    0.74848   3.113  0.00185 ** 
# relativeEarnings:poc1scaled  5.20103    3.10764   1.674  0.09420 .  
# poc1scaled:trialSC           2.37298    0.52849   4.490 7.12e-06 ***

# What this model means: negative past outcome effect (cool - expected), positive shift effect (also cool - expected), trending interaction between relative earnings and past outcome, and interaction bewteen trial and past outcome



# plotting relative earnings x outcome interaction - ONLY SHOWING ONE PART OF THE PICTURE HERE THO - but the effect is that there is a negative efffect of past outcome that gets weaker/flips slightly as participants do better in the task (when earnings are much more than expected). AS expected, this figure looks very similar to the earnings * outcome figure above.
contextResults = summary(m5_potc_shift_relativeEarn_trial)
poc= rep(c(0,.25,.5,.75, 1), times =5); # past outcome values
relEarnBeta = contextResults$coefficients[1]
pocBeta = contextResults$coefficients[2]
pocRelEarnBeta = contextResults$coefficients[5]
relEarnings = rep(c(-.12,-.05 ,0,.05, .11), each=5)


pgamRelEarnPOC =1/(1+exp(-1*( (relEarnBeta*relEarnings) + (pocBeta*poc) + (pocRelEarnBeta*poc*relEarnings) )));

png('../relativeEarnings.png')
plot(pgamRelEarnPOC[1:5], type = "l", ylim=c(0,.6), lwd=4, col="pink", ylab="p(gamble)", xlab="past outcome($)", axes=F, main="risk taking as a function of relative \nearnings and past outcome")
lines(pgamRelEarnPOC[6:10], lwd=4, col="lightpink" )
lines(pgamRelEarnPOC[11:15],lwd=4,col="pink2")
lines(pgamRelEarnPOC[16:20],lwd=4,col="pink3")
lines(pgamRelEarnPOC[21:25],lwd=4,col="pink4")

axis(2, at = seq(0, .6, by =.1), lwd=4)
axis(1, at=c(1:5), labels = round(poc[1:5]*max(mriBehClean$riskyGain), digits=0), lwd=4)
legend("bottomleft", legend=c("earn>>exp", "earn>exp", "earn=exp", "earn<exp", "earn<<exp"), bty="n", lty=1, lwd=4, col=c("pink4","pink3", "pink2" ,"lightpink", "pink"), title="relative earnings:")
dev.off();
```


```{r plot-past-outcome}
poc = seq(from=0, to = 1, by = .2); # values are scaled here

vniPOCgam = 1/(1+exp(-1*(contextResults$coefficients[2]*poc)))  # from the model where past outcome is alone 

png("../pastOutcomeEffectSize.png")
par(mar=c(5,6,6,3));#change margin so ylab is not cut off
plot(vniPOCgam, type = "l",axes = FALSE, xaxt="n", ann=F, lwd = 4, cex.lab=1, ylim=c(.25,.75))
title(ylab = "p(gamble)", line = 3.75, cex.lab=1.35)
title(xlab = "Past outcome", line = 2.5, cex.lab=1.35)
title(main = sprintf("Risk-taking following outcomes \npast outcome: %.2f(%.2f), p=%.2f", contextResults$coefficients[2],contextResults$coefficients[8] ,contextResults$coefficients[20]))
poclab = round(seq(from=0, to =61, length.out = 6), digits=0);
axis(1, at = c(1:6), labels =poclab, tick =T, cex.axis = 1.25, cex=2, lwd = 4)
axis(2, at = c(.25,round(vniPOCgam[2],digits=2),round(vniPOCgam[5], digits=2),.75), tick = T, las =2, cex.axis = 1.25, cex=2, lwd=4)
abline(a=.5,b=0, col="grey", lty=1, lwd=3)
lines(c(2,2), c(0,vniPOCgam[2]), lty = 4, col="red", lwd = 4);#vertical line at poc $14
lines(c(1,2),c(vniPOCgam[2],vniPOCgam[2]), lty=4, col="red", lwd =4); #horizontal line 
lines(c(5,5), c(0,vniPOCgam[5]), lty = 5, col="darkgreen", lwd = 4);
lines(c(1,5),c(vniPOCgam[5],vniPOCgam[5]), lty=5, col="darkgreen", lwd =4); 
lines(vniPOCgam, lwd=4); #plotting the line again so its on top.
dev.off();

```


```{r plot-shift-effect}

1/(1+exp(-1*(contextResults$coefficients[4]*max(mriBehClean$shiftDiffscPOS)))) # 0.6826262 is p(gamble | max shift up), vs. 0.5
# an increase of 18%
shiftvals = seq(from=0, to = max(mriBehClean$shiftDiffscPOS), length.out= 5)
vniShiftgam = 1/(1+exp(-1*(contextResults$coefficients[4]*shiftvals)))

png("../positiveShiftEffectSize.png")
par(mar=c(5,6,6,3));#change margin so ylab is not cut off
plot(vniShiftgam, type = "l",axes = FALSE, xaxt="n", ann=F, lwd = 4, cex.lab=1, ylim=c(.25,.75))
title(ylab = "p(gamble)", line = 3.75, cex.lab=1.35)
title(xlab = "Positive shift", line = 2.5, cex.lab=1.35)
title(main = sprintf("Risk-taking following positive shift \npositive shift: %.2f(%.2f), p=%f", contextResults$coefficients[4],contextResults$coefficients[10], contextResults$coefficients[22]))
shiftlab = c("$0", "$5","$10","15", "$20")
abline(a=.5,b=0, col="grey", lty=1, lwd=3)

axis(1, at = c(1:5), labels =shiftlab, tick =T, cex.axis = 1.25, cex=2, lwd = 4)
axis(2, at = c(.25,round(vniShiftgam[2],digits=2),round(vniShiftgam[5], digits = 2),.75), tick = T, las =2, cex.axis = 1.25, cex=2, lwd=4)

lines(c(2,2), c(-2,vniShiftgam[2]), lty = 4, col="red", lwd = 4);#
lines(c(1,2),c(vniShiftgam[2],vniShiftgam[2]), lty=4, col="red", lwd =4); #horizontal line 
lines(c(5,5), c(-2,vniShiftgam[5]), lty = 5, col="darkgreen", lwd = 4);
lines(c(1,5),c(vniShiftgam[5],vniShiftgam[5]), lty=5, col="darkgreen", lwd =4); 
lines(vniShiftgam, lwd=4); #plotting the line again so its on top.
dev.off();
```

```{r reaction-time-and-relative earnings}

# In the BOLD analysis, relative earnings was showing massive amounts of activity in the occipital lobe and other areas which suggests that the regressor might be accounting for other things like task engagement/fatigue/boredom, or time. 

# The model we used to create the relative earnings is model5_potc_posshift_earn_trial where earning betas = 2.3959 and expectations beta = -2.1927

# 1) let's look for a potential relationship between reaction time (proxy for engagement) and relative earnings
library(lmerTest)
mriBehClean$relativeEarningsWeighted = 2.3959*mriBehClean$earningsSC + -2.1927*mriBehClean$trialSC;

model_relEarnWeightedRTlmer = lmer(relativeEarningsWeighted~RTs+ (1|subjectIndex), data = mriBehClean);
summary(model_relEarnWeightedRTlmer); 
# positive relationship between reaction time and relative earnings. When earnings are more than expected (positive rel earn value), reaction times are slower (larger RTs); when earnings are less than expected (negative rel earn value), reaction times are faster (smaller RTs); This would suggest that at choice display, there is more being processed when earnings > expectations and why we see a BUNCH of activity for that regressor.



# 2) Next, lets look at a context-focused analysis with regressing choice on past ouctcome, positive shift and time (linear expectation) without earnings to see if this model outperforms a model with earnings
model_time = glmer(choice~0 + poc1scaled + trialSC + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model_time); # AIC =  7589.1; no main effect of trial

model_earnings = glmer(choice~0 + poc1scaled + earningsSC + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model_earnings); # AIC =  7587.9 ; no main effect of earnings but AIC is better


# 3) Do regressions on task stimuli so that the DV is risky gain or safe amount regressed on time so that we can say whether the task itself doesn't have anything that is correlated with time. Basically, we want to know if there is any indication that behavior shows some changes over time.

model_gainTime = lm(gainSC ~ trialSC, data= mriBehClean)
# risky gain values increase with time

model_safeTime = lm(altSC ~ trialSC, data= mriBehClean)
summary(model_safeTime)
# trending positive relationship between time and safe amounts

# plot average gain and safe values across the task for all participants
tmpgain = vector()
tmpsafe = vector()
for (i in 1:219){
  tmpgain[i]= mean(mriBehClean$gainSC[mriBehClean$trial==i])
  tmpsafe[i]= mean(mriBehClean$altSC[mriBehClean$trial==i])
}

plot(tmpgain)
plot(tmpsafe)


```
 
```{r choice-difficulty}

# In our BOLD analysis, it looks like outcome display (model 4 and 5) could be missing something
# What if we take into consideration other things going on like hard vs. easy choice on the current trial (centered around their indifference point). 
# Model 1: risky gain, safe and magnitude. Already have this
# Model 2: Then account for previous outcome. Model 2 might be the only piece that I need.
# The check is looking at predictions of model 1: what is the trial-by-trial prediction (indifference would be showing this prediction at .5)
# Then looking at model 2: what is the trial-by-trial prediction
# We could subtract these two predictions and we would see the change in action as a function of previous otucome. So this could show us that past outcome was enormous or it was a moderate one at the right time.

summary(model1_trialLevel); # model with gain, safe and magnitude
predictedValues = predict(model1_trialLevel,type="response"); # this gets predicted responses (p(gamble)) on each trial

predictedValues[is.na(mriBehClean$poc1scaled)] = NA # index where the NAs occur poc variable
predictedValuesMod1 = predictedValues[!is.na(predictedValues)] # remove NAs
# the predicted values from the model above accounts for all trials but the predicted values from the model with past outcome has missing values for first trials for each participant, so let's get rid of those values so that the length of the predictedValues and predictedValuesOC vectors are the same.

summary(model2_potc_amt); # model with outcome only
predictedValuesOC = predict(model2_potc_amt,type="response"); # this gets predicted responses (p(gamble)) on each trial

predictionDiff= predictedValuesMod1 - predictedValuesOC; 
# unclear if the following is correct but:
# positive difference -> negative change in action as a function of past outcome (because trial-level model predicted more gambling than past outcome model did) 
# no difference -> there wasn't a change in action as a function of past outcome
# negative difference -> positive change in action as a function of past outcome (because trial-level model predicted less gambling than past outcome model did)


# just look at first participant
sub1mod1 = predictedValuesMod1[1:218] # don't include first trial because of poc NA situation
sub1mod2 = predictedValuesOC[1:218]
sub1diff = predictionDiff[1:218]
plot(sub1mod1, col=rgb(red=0, green=0, blue=1, alpha=.5), pch=16, cex=1.5)
points(sub1mod2, col=rgb(red=1, green=0, blue=0, alpha=.5), pch=16, cex=1.5)
# points are mostly overlapping and differences are very small

plot(sub1diff, col=rgb(red=0, green=1, blue=0, alpha=.5), pch=16, cex=1.5)
# for this participant there was a negative change in risk-taking as a function of past outcome (positive values mean model 1 over predicted gambling behavior)

```
 

```{r regression-for-rcs-parameter recovery}
# we will use earningsSC instead of earning normalized
# earningsSC is large compared to the other values and the model breaks,
# so we will scale it by 100 to make it smaller, and just make sure to do that in the RCS parameter recovery
mriBehClean$earningsSCdouble=mriBehClean$earningsSC/max(mriBehClean$earningsSC); # these are basically double scaled now but range from 0-1; max(mriBehClean$earningsSC = 66.75)
modelRCS_potc_posshift_earn_trial_intxns = glmer(choice~0 + earningsSCdouble*poc1scaled + trialSC*poc1scaled + shiftDiffscPOS + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(modelRCS_potc_posshift_earn_trial_intxns); # AIC =  7547.1 

#                       Estimate Std. Error z value Pr(>|z|)    
# earningsSCdouble             1.5493     1.1074   1.399  0.16180    
# poc1scaled             -0.7730     0.1685  -4.588 4.47e-06 ***
# trialSC                -1.4531     0.9589  -1.515  0.12967    
# shiftDiffscPOS          2.3303     0.7474   3.118  0.00182 ** 
# earningsSCdouble:poc1scaled   5.2010     3.1168   1.669  0.09517 .  # this is slightly weaker than earningsNormalized p=03
# poc1scaled:trialSC     -2.8280     2.7232  -1.039  0.29903  


```



#### Individual-level analyses (glm)
###### output = contextResults {"subID", "pocBeta", "pocPval", "shiftBeta", "shiftPval", "relEarnBeta", "relEarnPval"}
a.	After accounting for trial-level effects (gain, safe, EV), there are only a handful of participants who have significant context effects at each level. 

```{r participant-level}
subsTriLevMods = list();
#subsPocMods = list();
subsContextMods = list();
trialLevelResults = as.data.frame(matrix(data = NA, nrow = nSub, ncol=3, dimnames=list(c(NULL), c("subID","beta","pval"))))
#pocResults = as.data.frame(matrix(data = NA, nrow = nSub, ncol=3, dimnames=list(c(NULL), c("subID","beta","pval"))))
contextResults = as.data.frame(matrix(data=NA,nrow=nSub, ncol=7, dimnames=list(c(NULL), c("subID", "pocBeta", "pocPval", "shiftBeta", "shiftPval", "relEarnBeta", "relEarnPval"))))

for (s in 1:nSub) {
  sub = mriBehClean[mriBehClean$subjectIndex==subIDs[s],]; # pull out a single subject
  
  subsTriLevMods[[s]] = glm(choice~gainSC + altSC + grndEVscaled, data=sub, family="binomial"); # run the trial level model

  sub$pred = predict(subsTriLevMods[[s]],type='link'); # get predicted values
  
  subsContextMods[[s]] = glm(choice~poc1scaled + shiftDiffscPOS1 + relativeEarnings*poc1scaled + trialSC*poc1scaled, data=sub, family="binomial", offset=pred)
  
  #subsPocMods[[s]] = glm(choice~poc1scaled, data=sub, family="binomial", offset=pred); # past outcome model with predicted values
  
  
  tmp =summary(subsContextMods[[s]]); #store coefficients from poc model
  contextResults$subID[s] = subIDs[s]; # fill in sub ID
  contextResults$pocBeta[s] = tmp$coefficients[[2]]; # store poc beta
  contextResults$pocPval[s] = tmp$coefficients[[23]]; # store poc pvalue
  contextResults$shiftBeta[s] = tmp$coefficients[[3]]; # store shift beta
  contextResults$shiftPval[s] = tmp$coefficients[[24]]; # store shift pvalue
  contextResults$relEarnBeta[s] = tmp$coefficients[[4]]; # store relative earnings beta
  contextResults$relEarnPval[s] = tmp$coefficients[[25]]; # store relative pvalue
}; 

print(contextResults)
```

**Plot the individual past outcome results**
```{r plot-sub-level-context-effects}
pdf('../figures/subjectContextEffects.pdf')
plot(contextResults$pocBeta, ylim=c(min(contextResults$pocBeta),max(contextResults$pocBeta)), pch=16, main=sprintf("Individual past outcome estimates (n=%s)", nSub), xlab="participant", ylab="estimate", col= ifelse(contextResults$pocPval<.05, "green", ifelse(contextResults$pocPval<.1 & contextResults$pocPval>.05,"blue", "black")), cex=1.75); # blue is trending, green is significant, black is neither
abline(a=0,b=0, col="grey");
legend("topright", legend= c("p < .05", ".05 < p < .1", "p > .1"), bty="n", pch = 16, col=c("green", "blue", "black"));


plot(contextResults$shiftBeta, ylim=c(min(contextResults$shiftBeta),max(contextResults$shiftBeta)), pch=16, main=sprintf("Individual positive shift estimates (n=%s)", nSub), xlab="participant", ylab="estimate", col= ifelse(contextResults$shiftPval<.05, "green", ifelse(contextResults$shiftPval<.1 & contextResults$shiftPval>.05,"blue", "black")), cex=1.75); # blue is trending, green is significant, black is neither
abline(a=0,b=0, col="grey");
legend("bottomright", legend= c("p < .05", ".05 < p < .1", "p > .1"), bty="n", pch = 16, col=c("green", "blue", "black"));


plot(contextResults$relEarnBeta, ylim=c(min(contextResults$relEarnBeta),max(contextResults$relEarnBeta)), pch=16, main=sprintf("Individual relative earning estimates (n=%s)", nSub), xlab="participant", ylab="estimate", col= ifelse(contextResults$relEarnPval<.05, "green", ifelse(contextResults$relEarnPval<.1 & contextResults$relEarnPval>.05,"blue", "black")), cex=1.75); # blue is trending, green is significant, black is neither
abline(a=0,b=0, col="grey");
legend("bottomright", legend= c("p < .05", ".05 < p < .1", "p > .1"), bty="n", pch = 16, col=c("green", "blue", "black"));

dev.off()
```

