---
title: "VNI Analysis of RDM behavior"
author: "Hayley Brooks"
---

Tips/Tricks from template:
1) Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
2) Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.
3) When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 
4) The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

Output
  1) indivPOCestimates.pdf - plots each sub's past outcome betas
  2) runSizeShiftFigs.pdf- plots change in risk taking following negative shift as a function of shift and run size
  3) ocEarnIntxOnly.pdf - risk taking as a fucntion of outcomes x earnings plotting only interaction
  4) ocEarnIntx.pdf - risk taking as a function of outcomes x earnings interaction plotting all variables in the model
  5) taskEarnings.pdf - earnings for each participant over the task


# Set up the environment/path
```{r}
rm(list=ls());  # clear environment


library(config)
config <- config::get()

load("/Volumes/shlab/Projects/VNI/data/mriBehaviorClean/group_mriBehavior_clean.Rdata"); # mriBehClean data frame
```



Load packages
```{r}
library(lme4);
library(lmerTest);
```


Subject information
```{r}
subIDs = unique(mriBehClean$subjectIndex);
nSub = length(subIDs);
print(nSub)
```


FOR THIS ANALYSIS, WE WANT TO KNOW IF RISK TAKING (RESIDUALS) CHANGES AS A FUNCTION OF TEMPORAL CONTEXT AT THREE LEVELS:
1) PAST OUTCOME (IMMEDIATE)
2) SHIFTS (NEIGHBORHOOD)
3) CUMULATIVE EARNINGS (GLOBAL)

INDIVIDUAL-LEVEL ANALYSES
  DOES RISK-TAKING CHANGE ON THE IMMEDIATE LEVEL OF TEMPORAL CONTEXT?
  Iindividual-level past outcome glms

```{r}
subsTriLevMods = list();
subsPocMods = list();
trialLevelResults = as.data.frame(matrix(data = NA, nrow = nSub, ncol=3, dimnames=list(c(NULL), c("subID","beta","pval"))))
pocResults = as.data.frame(matrix(data = NA, nrow = nSub, ncol=3, dimnames=list(c(NULL), c("subID","beta","pval"))))

for (s in 1:nSub) {
  sub = mriBehClean[mriBehClean$subjectIndex==subIDs[s],]; # pull out a single subject
  
  subsTriLevMods[[s]] = glm(choice~gainSC + altSC + grndEVscaled, data=sub, family="binomial"); # run the trial levelm odel

  sub$pred = predict(subsTriLevMods[[s]],type='link'); # get predicted values
  
  subsPocMods[[s]] = glm(choice~poc1scaled, data=sub, family="binomial", offset=pred); # past outcome model with predicted values
  
  tmp =summary(subsPocMods[[s]]); #store coefficients from poc model
  pocResults$subID[s] = subIDs[s]; # fill in sub ID
  pocResults$beta[s] = tmp$coefficients[[2]]; # store beta
  pocResults$pval[s] = tmp$coefficients[[8]]; # store pvalue
}; 


print(pocResults)

sprintf(" %d participants had a negative, significant past outcome beta and %d participants had a positive, significant outcome beta", sum(pocResults$pval<.05 & pocResults$beta <0), sum(pocResults$pval<.05 & pocResults$beta >0))
```

Plot the individual past outcome results
Blue is trending, green is significant, black is not significant or trending
```{r}

plot(pocResults$beta, ylim=c(min(pocResults$beta),max(pocResults$beta)), pch=16, main=sprintf("Individual past outcome estimates (n=%s)", nSub), xlab="participant", ylab="estimate", col= ifelse(pocResults[,3]<.05, "green", ifelse(pocResults[,3]<.1 & pocResults$pval>.05,"blue", "black")), cex=1.75); # blue is trending, green is significant, black is neither
abline(a=0,b=0, col="grey")



```

GROUP LEVEL ANALYSIS (LME4)

Trial-level variables (model is identical to VIC):
Summary: Participants more likely to choose an option as its amount increases (no effect of ground expected value)

```{r}
model1_trialLevel = glmer(choice~ 0 + gainSC + altSC + grndEVscaled + (0+ gainSC + altSC|subjectIndex), data = mriBehClean, family = "binomial");

summary(model1_trialLevel);

```


Pull out "predicted" values from trial-level model and save as variable "pred" in mriBehClean dataframe
```{r}

mriBehClean$pred= predict(model1_trialLevel,type="link"); 
par(mfrow=c(1,1))
plot(mriBehClean$pred, ylab="predicted values");

```


###### Does temporal context influence risk taking? #######

Each timescale of temporal context in models alone

Past outcome:
```{r}
model2_potc_amt = glmer(choice ~ 0 + poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_amt);  # ns; AIC = 7592.9 

model2_potc_type = glmer(choice ~ 0 + poc1type + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_type); # ns; AIC =7592.1 

model2_potc_amt_type_intxn = glmer(choice ~ 0 + poc1type*poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model2_potc_amt_type_intxn); # negative interaction between outcome type and amount; AIC = 7588.0

```

LEFT OFFHERE _ best way to show this because risky loss amount is always 0
Plot the interaction between past outcome amount and type:
Outcome type is coded: 0 = safe; 1 = risky gain; -1 = risky loss (always $0)
```{r}
poc = seq(from=min(mriBehClean$poc1scaled, na.rm=T), to=max(mriBehClean$poc1scaled, na.rm = T), length.out = 3);
poctype = c(0,1,-1)

m2coef = fixef(model2_potc_amt_type_intxn)

m2_pgam = 1/(1+exp(-1*(m2coef[1]*poctype + m2coef[2]*poc + m2coef[3]*poctype*poc)))  # from the model where past outcome is alone 



```



Shift:
```{r}

model3_signed_shifts = glmer(choice~0 + shiftDiffsc + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_shifts); # significant

model3_pos_neg_shifts = glmer(choice ~ 0 + shiftDiffscPOS + shiftDiffscNEG + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_shifts); # only positive significant

model3_abs_shift = glmer(choice ~ 0 + shiftDiffscABs + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_abs_shift); #ns


# Similar to VIC, we see an effect of positive shift only with risk-taking increasing. H
# How far back does it go?

# create new positive shift variable (n-1)

# shift so that this variable captures the past outcome
newMat = matrix(data=NA,nrow=nrow(mriBehClean), ncol=2);
newMat[,1] <- mriBehClean$shiftDiffscPOS; #take data from columns
newMat[2:nrow(newMat),1] <- newMat[1:(nrow(newMat)-1),1]; # removes first row, shifts everything up
newMat[1,1] <- NaN #put Nan in for first row (first trial for subject 1, bc there is no past trial)
newMat[,2]<-c(0,diff(mriBehClean$subjectIndex)); #put differences between NewSubjectIndex into newvector, 1s show up when subject changes
newMat[newMat[,2]==1,]=NaN; #in newmtx, when diff = 1, replace with NaN, this replaces first trial with nan
mriBehClean$shiftDiffscPOS1 = newMat[,1];# add new vector to mriBehClean

model3_pos_shift_howfarback = glmer(choice ~ 0 + shiftDiffscPOS + shiftDiffscPOS1 + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_pos_shift_howfarback); #shoft lasting, only trial directly after a shift


# Does run size preceeding positive shift matter?
model3_posShift_runSize = glmer(choice ~ 0 + shiftDiffscPOS*runSizeShift + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_posShift_runSize); #ns


model3_shift_pos_neg_runSize = glmer(choice ~ 0 + shiftDiffscPOS*runSizePOS + shiftDiffscNEG*runSizeNEG + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_shift_pos_neg_runSize); #ns


model3_shift_pos_runSize = glmer(choice ~ 0 + shiftDiffscPOS*runSizePOS +(1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_shift_pos_runSize); #ns

# unclear if runSizeShift is too similar a variable to positive/negative shift? when it is in a model with shift (signed) there is a main effect of run size but no interaction


# Does positive shift interact with past outcome?
model3_posShift_potc_intxn = glmer(choice ~ 0 + shiftDiffscPOS*poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model3_posShift_potc_intxn); #ns

```


Earnings (and trial)
```{r}
model4_earnings_trial = glmer(choice~0 + earningsNormalized + trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earnings_trial); # both significant, betas similar size but opposite valence, AIC = 7657.1 


model4_earnings_trial_intxn = glmer(choice~0 + earningsNormalized*trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earnings_trial_intxn); # interaction trending, AIC = 7655.5

# Earnings interact with past outcome in previous datasets, does that happen here?
model4_earnings_potc_intxn = glmer(choice~0 + earningsNormalized*poc1scaled + trialSC*poc1scaled + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred);
summary(model4_earnings_potc_intxn); # past outcome, and interaction between outcomes and earnings are significant. Main effects of earnings and trial go away (consistent with previous datasets, eg. VIC). Interaction betwee outcome and trial is trending p =.07
# model fails to converge though

```


Each timescale in a single model:
```{r}
model5_potc_posshift_earn_trial = glmer(choice ~ 0 + poc1scaled + shiftDiffscPOS + earningsNormalized*poc1scaled + trialSC + (1|subjectIndex), data=mriBehClean, family="binomial", offset=pred)

summary(model5_potc_posshift_earn_trial); # everything significant
```



