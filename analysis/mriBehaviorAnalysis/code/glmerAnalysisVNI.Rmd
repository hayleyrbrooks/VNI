---
title: "VNI Analysis of RDM behavior"
author: "Hayley Brooks"
---

Tips/Tricks from template:
1) Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
2) Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.
3) When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 
4) The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

Output
  1) indivPOCestimates.pdf - plots each sub's past outcome betas
  2) runSizeShiftFigs.pdf- plots change in risk taking following negative shift as a function of shift and run size
  3) ocEarnIntxOnly.pdf - risk taking as a fucntion of outcomes x earnings plotting only interaction
  4) ocEarnIntx.pdf - risk taking as a function of outcomes x earnings interaction plotting all variables in the model
  5) taskEarnings.pdf - earnings for each participant over the task


# Config
```{r}
library(config)
config::get()
```

Load packages
```{r}
library(lme4);
library(lmerTest);
```


Set up the environment
```{r}
rm(list=ls());  # clear environment
load("/Volumes/shlab/Projects/VNI/data/mriBehaviorClean/group_mriBehavior_clean.Rdata"); # mriBehClean data frame
```


Subject information
```{r}
subIDs = unique(mriBehClean$subjectIndex);
nSub = length(subIDs);
print(nSub)
```


FOR THIS ANALYSIS, WE WANT TO KNOW IF RISK TAKING (RESIDUALS) CHANGES AS A FUNCTION OF TEMPORAL CONTEXT AT THREE LEVELS:
1) PAST OUTCOME (IMMEDIATE)
2) SHIFTS (NEIGHBORHOOD)
3) CUMULATIVE EARNINGS (GLOBAL)

INDIVIDUAL-LEVEL ANALYSES
  DOES RISK-TAKING CHANGE ON THE IMMEDIATE LEVEL OF TEMPORAL CONTEXT?
  Iindividual-level past outcome glms

```{r}
subsTriLevMods = list();
subsPocMods = list();
trialLevelResults = as.data.frame(matrix(data = NA, nrow = nSub, ncol=3, dimnames=list(c(NULL), c("subID","beta","pval"))))
pocResults = as.data.frame(matrix(data = NA, nrow = nSub, ncol=3, dimnames=list(c(NULL), c("subID","beta","pval"))))

for (s in 1:nSub) {
  sub = mriBehClean[mriBehClean$subjectIndex==subIDs[s],]; # pull out a single subject
  
  subsTriLevMods[[s]] = glm(choice~gainSC + altSC + grndEVscaled, data=sub, family="binomial"); # run the trial levelm odel

  sub$pred = predict(subsTriLevMods[[s]],type='link'); # get predicted values
  
  subsPocMods[[s]] = glm(choice~poc1scaled, data=sub, family="binomial", offset=pred); # past outcome model with predicted values
  
  tmp =summary(subsPocMods[[s]]); #store coefficients from poc model
  pocResults$subID[s] = subIDs[s]; # fill in sub ID
  pocResults$beta[s] = tmp$coefficients[[2]]; # store beta
  pocResults$pval[s] = tmp$coefficients[[8]]; # store pvalue
}; 


print(pocResults)

sprintf(" %d participants had a negative, significant past outcome beta and %d participants had a positive, significant outcome beta", sum(pocResults$pval<.05 & pocResults$beta <0), sum(pocResults$pval<.05 & pocResults$beta >0))
```

Plot the individual past outcome results
Blue is trending, green is significant, black is not significant or trending
```{r}

plot(pocResults$beta, ylim=c(min(pocResults$beta),max(pocResults$beta)), pch=16, main=sprintf("Individual past outcome estimates (n=%s)", nSub), xlab="participant", ylab="estimate", col= ifelse(pocResults[,3]<.05, "green", ifelse(pocResults[,3]<.1 & pocResults$pval>.05,"blue", "black")), cex=1.75); # blue is trending, green is significant, black is neither
abline(a=0,b=0, col="grey")



```





